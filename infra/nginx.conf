# Hardened nginx configuration. This configuration expects:
# - TLS certificate and key at /etc/nginx/certs/server.crt/.key
# - CA cert at /etc/nginx/certs/ca.crt
#
# Important: To safely forward client certificate to backend, compute an HMAC signature
# over the client cert PEM and send it in X-Client-Cert-Signature header. The backend
# verifies the HMAC using HEADER_HMAC_SECRET. Nginx alone cannot compute HMAC without
# the lua module. For development you can run the server with mTLS directly (see server/uvicorn_run.py).
#
# For production:
# - Use nginx with the ngx_http_lua_module to compute HMAC on forwarded headers, or
# - use a small sidecar process to perform header signing, or
# - run backend with mTLS directly.

worker_processes auto;
events { worker_connections 1024; }

http {
    # TLS hardening
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;

    upstream backend {
        server server:8080;  # server runs on 8080 (internal, uvicorn without TLS)
    }

    server {
        listen 443 ssl http2;
        server_name _;

        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        ssl_client_certificate /etc/nginx/certs/ca.crt;
        ssl_verify_client on;  # enforce mTLS

        # Forward client cert PEM in header. NOTE: header MUST be signed for authenticity.
        proxy_set_header X-Client-Cert $ssl_client_cert;
        # Proxy must also forward signature header computed by a trusted signer (see docs).
        # e.g. proxy_set_header X-Client-Cert-Signature "<computed-hmac>";

        # Protect backend
        proxy_hide_header X-Powered-By;
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        location / {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

    }
}